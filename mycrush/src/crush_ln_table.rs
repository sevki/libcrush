// Complete lookup tables from crush_ln_table.h

// RH_LH_tbl[2*k] = 2^48/(1.0+k/128.0)
// RH_LH_tbl[2*k+1] = 2^48*log2(1.0+k/128.0)
#[rustfmt::skip]
pub const RH_LH_TBL: [i64; 128 * 2 + 2] = [
    0x0001000000000000i64, 0x0000000000000000i64, 0x0000fe03f80fe040i64, 0x000002dfca16dde1i64,
    0x0000fc0fc0fc0fc1i64, 0x000005b9e5a170b4i64, 0x0000fa232cf25214i64, 0x0000088e68ea899ai64,
    0x0000f83e0f83e0f9i64, 0x00000b5d69bac77ei64, 0x0000f6603d980f67i64, 0x00000e26fd5c8555i64,
    0x0000f4898d5f85bci64, 0x000010eb389fa29fi64, 0x0000f2b9d6480f2ci64, 0x000013aa2fdd27f1i64,
    0x0000f0f0f0f0f0f1i64, 0x00001663f6fac913i64, 0x0000ef2eb71fc435i64, 0x00001918a16e4633i64,
    0x0000ed7303b5cc0fi64, 0x00001bc84240adabi64, 0x0000ebbdb2a5c162i64, 0x00001e72ec117fa5i64,
    0x0000ea0ea0ea0ea1i64, 0x00002118b119b4f3i64, 0x0000e865ac7b7604i64, 0x000023b9a32eaa56i64,
    0x0000e6c2b4481cd9i64, 0x00002655d3c4f15ci64, 0x0000e525982af70di64, 0x000028ed53f307eei64,
    0x0000e38e38e38e39i64, 0x00002b803473f7adi64, 0x0000e1fc780e1fc8i64, 0x00002e0e85a9de04i64,
    0x0000e070381c0e08i64, 0x0000309857a05e07i64, 0x0000dee95c4ca038i64, 0x0000331dba0efce1i64,
    0x0000dd67c8a60dd7i64, 0x0000359ebc5b69d9i64, 0x0000dbeb61eed19di64, 0x0000381b6d9bb29bi64,
    0x0000da740da740dbi64, 0x00003a93dc9864b2i64, 0x0000d901b2036407i64, 0x00003d0817ce9cd4i64,
    0x0000d79435e50d7ai64, 0x00003f782d7204d0i64, 0x0000d62b80d62b81i64, 0x000041e42b6ec0c0i64,
    0x0000d4c77b03531ei64, 0x0000444c1f6b4c2di64, 0x0000d3680d3680d4i64, 0x000046b016ca47c1i64,
    0x0000d20d20d20d21i64, 0x000049101eac381ci64, 0x0000d0b69fcbd259i64, 0x00004b6c43f1366ai64,
    0x0000cf6474a8819fi64, 0x00004dc4933a9337i64, 0x0000ce168a772509i64, 0x0000501918ec6c11i64,
    0x0000cccccccccccdi64, 0x00005269e12f346ei64, 0x0000cb8727c065c4i64, 0x000054b6f7f1325ai64,
    0x0000ca4587e6b750i64, 0x0000570068e7ef5ai64, 0x0000c907da4e8712i64, 0x000059463f919deei64,
    0x0000c7ce0c7ce0c8i64, 0x00005b8887367433i64, 0x0000c6980c6980c7i64, 0x00005dc74ae9fbeci64,
    0x0000c5650c5650c6i64, 0x00006002760308f6i64, 0x0000c4362750c436i64, 0x0000623a175a45aci64,
    0x0000c30c30c30c31i64, 0x000064684df313a4i64, 0x0000c1e4bbd595f6i64, 0x0000669316e6bcd0i64,
    0x0000c0c0c0c0c0c1i64, 0x000068bab2bb7763i64, 0x0000bfa02fe80bfai64, 0x00006adf2def5b59i64,
    0x0000be82fa0be830i64, 0x00006d00952143bbi64, 0x0000bd6910e183bdi64, 0x00006f1f06ce855fi64,
    0x0000bc5264c87c31i64, 0x00007119a4b29a3ci64, 0x0000bb3ee721a54di64, 0x000073318b63abadi64,
    0x0000ba2e8ba2e8bai64, 0x0000754de67e7a8fi64, 0x0000b92146071b92i64, 0x000077679e07d40di64,
    0x0000b81702e05c0bi64, 0x0000795eb4a1e8c0i64, 0x0000b70fbb5a19bei64, 0x00007b7435f6a5b3i64,
    0x0000b60b60b60b61i64, 0x00007d873405e6d7i64, 0x0000b509e68a9b95i64, 0x00007f97bb7e3a2bi64,
    0x0000b40b40b40b41i64, 0x000081a5cd1b1f66i64, 0x0000b30f63528918i64, 0x000083b173b8b2fci64,
    0x0000b21642c8590bi64, 0x000085bab41b8b5di64, 0x0000b11fd3b80b12i64, 0x000087c1a3a80419i64,
    0x0000b02c0b02c0b0i64, 0x000089c6488e8ac4i64, 0x0000af3adc30afd3i64, 0x00008bc8a76a7cd4i64,
    0x0000ae4c415c9882i64, 0x00008dc8c4c6f8d6i64, 0x0000ad602b580ad6i64, 0x00008fc6a5c1cfe9i64,
    0x0000ac7691840ac8i64, 0x000091c25e0c1511i64, 0x0000ab8f69e28376i64, 0x000093bbeaa0bfbdi64,
    0x0000aaaaaaaaaaabi64, 0x000095b34a0b5bc6i64, 0x0000a9c84a47a07fi64, 0x000097a880c44a3fi64,
    0x0000a8e83f5717c1i64, 0x0000999b92bfa29di64, 0x0000a80a80a80a81i64, 0x00009b8c7b7e4011i64,
    0x0000a72f05397829i64, 0x00009d7b3ed6c3fdi64, 0x0000a655c4392d7bi64, 0x00009f67dffe6c6di64,
    0x0000a57eb5026af0i64, 0x0000a1525cd69a0bi64, 0x0000a4a9cf1d96a5i64, 0x0000a33abd7c9b7ci64,
    0x0000a3d70a3d70a4i64, 0x0000a5210469bd68i64, 0x0000a3065e3fae7ci64, 0x0000a7053b5f6e58i64,
    0x0000a237c32b16cei64, 0x0000a8e7577d0f87i64, 0x0000a16b312ea8fci64, 0x0000aac75b5fc1b4i64,
    0x0000a0a0a0a0a0a1i64, 0x0000aca542c2be82i64, 0x00009fd8092aeaf5i64, 0x0000ae811129e5a4i64,
    0x00009f1165e7254fi64, 0x0000b05ac16cddfbi64, 0x00009e4cad23dd5fi64, 0x0000b2325605b86ei64,
    0x00009d89d89d89d9i64, 0x0000b407cf0e0fe4i64, 0x00009cc8e160c3fbi64, 0x0000b5db2f5c0602i64,
    0x00009c09c09c09c1i64, 0x0000b7ac7a9e8035i64, 0x00009b4c6f9ef03bi64, 0x0000b97bb22adcc8i64,
    0x00009a90e7d95bc6i64, 0x0000bb48d802b8b4i64, 0x000099d722dabde6i64, 0x0000bd13ed8e8e81i64,
    0x0000991f1a515886i64, 0x0000bedc756dced2i64, 0x000098685871dc8ci64, 0x0000c0a2d11e6b17i64,
    0x000097b425ed097ci64, 0x0000c2671c7cc63ei64, 0x000097012e025c05i64, 0x0000c42959928c75i64,
    0x0000964fda6c0965i64, 0x0000c5e98a2a888di64, 0x000095a02568095ai64, 0x0000c7a7b10cb3aei64,
    0x000094f2094f2095i64, 0x0000c963d09e8cfai64, 0x0000944580944581i64, 0x0000cb1deeae0feai64,
    0x0000939a85c4093ai64, 0x0000ccd60ea3b88ei64, 0x000092f113840498i64, 0x0000ce8c35ad5dc3i64,
    0x0000924924924925i64, 0x0000d040688c9b7ei64, 0x000091a2b3c4d5e7i64, 0x0000d1f2ac5b93f5i64,
    0x000090fdbc090fdci64, 0x0000d3a3056c86ddi64, 0x0000905a38633e07i64, 0x0000d5517890b8a8i64,
    0x00008fb823ee08fci64, 0x0000d6fe101fb09ci64, 0x00008f1779d9fdc4i64, 0x0000d8a8d4b70a3bi64,
    0x00008e78356d1409i64, 0x0000da51d396b03di64, 0x00008dda5202376ai64, 0x0000dbf91e6556fdi64,
    0x00008d3dcb08d3ddi64, 0x0000dd9eb56b6681i64, 0x00008ca29c046515i64, 0x0000df4299e0e19bi64,
    0x00008c08c08c08c1i64, 0x0000e0e4cca1e3a0i64, 0x00008b70344a139ci64, 0x0000e285520ef2fci64,
    0x00008ad8f2fba939i64, 0x0000e4242c23a712i64, 0x00008a42f870566ai64, 0x0000e5c1632b69fdi64,
    0x000089ae4089ae41i64, 0x0000e75cf84c2e05i64, 0x0000891ac73ae982i64, 0x0000e8f6ec9c7247i64,
    0x0000888888888889i64, 0x0000ea8f41a8c7fdi64, 0x000087f78087f781i64, 0x0000ec25f8cd9c68i64,
    0x00008767ab5f34e5i64, 0x0000edbb12ddc1c0i64, 0x000086d905447a35i64, 0x0000ef4e92006b10i64,
    0x0000864b8a7de6d2i64, 0x0000f0e077e4e94ei64, 0x000085bf37612cefi64, 0x0000f270c67c0fa8i64,
    0x0000853408534086i64, 0x0000f3ff7fbe3ae5i64, 0x000084a9f9c8084bi64, 0x0000f58ca5080626i64,
    0x0000842108421085i64, 0x0000f7183798ee23i64, 0x0000839930523fbfi64, 0x0000f8a23936b7a8i64,
    0x000083126e978d50i64, 0x0000fa2aab2b1fcdi64, 0x0000828cbfbeb9a1i64, 0x0000fbb18ea8088di64,
    0x0000820820820821i64, 0x0000fd36e5e3a55fi64, 0x000081848da8faf1i64, 0x0000feb5b299cc32i64,
    0x0000810204081021i64, 0x000100330c8a6068i64, 0x0000808080808081i64, 0x0001018ef5a1e830i64,
];

// LL_tbl[k] = 2^48*log2(1.0+k/2^15)
#[rustfmt::skip]
pub const LL_TBL: [i64; 256] = [
    0x0000000000000000i64, 0x00000002e2a60a00i64, 0x000000070cb64ec5i64, 0x00000009ef50ce67i64,
    0x0000000cd1e588fdi64, 0x0000000fb4747e9ci64, 0x0000001296fdaf5ei64, 0x0000001579811b58i64,
    0x000000185bfec2a1i64, 0x0000001b3e76a552i64, 0x0000001e20e8c380i64, 0x0000002103551d43i64,
    0x00000023e5bbb2b2i64, 0x00000026c81c83e4i64, 0x00000029aa7790f0i64, 0x0000002c8cccd9edi64,
    0x0000002f6f1c5ef2i64, 0x0000003251662017i64, 0x0000003533aa1d71i64, 0x0000003815e8571ai64,
    0x0000003af820cd26i64, 0x0000003dda537faei64, 0x00000040bc806ec8i64, 0x000000439ea79a8ci64,
    0x0000004680c90310i64, 0x0000004962e4a86ci64, 0x0000004c44fa8ab6i64, 0x0000004f270aaa06i64,
    0x0000005209150672i64, 0x00000054eb19a013i64, 0x00000057cd1876fdi64, 0x0000005aaf118b4ai64,
    0x0000005d9104dd0fi64, 0x0000006072f26c64i64, 0x0000006354da3960i64, 0x0000006636bc441ai64,
    0x0000006918988ca8i64, 0x0000006bfa6f1322i64, 0x0000006edc3fd79fi64, 0x00000071be0ada35i64,
    0x000000749fd01afdi64, 0x00000077818f9a0ci64, 0x0000007a6349577ai64, 0x0000007d44fd535ei64,
    0x0000008026ab8dcei64, 0x00000083085406e3i64, 0x00000085e9f6beb2i64, 0x00000088cb93b552i64,
    0x0000008bad2aeadci64, 0x0000008e8ebc5f65i64, 0x0000009170481305i64, 0x0000009451ce05d3i64,
    0x00000097334e37e5i64, 0x0000009a14c8a953i64, 0x0000009cf63d5a33i64, 0x0000009fd7ac4a9di64,
    0x000000a2b07f3458i64, 0x000000a59a78ea6ai64, 0x000000a87bd699fbi64, 0x000000ab5d2e8970i64,
    0x000000ae3e80b8e3i64, 0x000000b11fcd2869i64, 0x000000b40113d818i64, 0x000000b6e254c80ai64,
    0x000000b9c38ff853i64, 0x000000bca4c5690ci64, 0x000000bf85f51a4ai64, 0x000000c2671f0c26i64,
    0x000000c548433eb6i64, 0x000000c82961b211i64, 0x000000cb0a7a664di64, 0x000000cdeb8d5b82i64,
    0x000000d0cc9a91c8i64, 0x000000d3ada20933i64, 0x000000d68ea3c1ddi64, 0x000000d96f9fbbdbi64,
    0x000000dc5095f744i64, 0x000000df31867430i64, 0x000000e2127132b5i64, 0x000000e4f35632eai64,
    0x000000e7d43574e6i64, 0x000000eab50ef8c1i64, 0x000000ed95e2be90i64, 0x000000f076b0c66ci64,
    0x000000f35779106ai64, 0x000000f6383b9ca2i64, 0x000000f918f86b2ai64, 0x000000fbf9af7c1ai64,
    0x000000feda60cf88i64, 0x00000101bb0c658ci64, 0x000001049bb23e3ci64, 0x000001077c5259afi64,
    0x0000010a5cecb7fci64, 0x0000010d3d81593ai64, 0x000001101e103d7fi64, 0x00000112fe9964e4i64,
    0x00000115df1ccf7ei64, 0x00000118bf9a7d64i64, 0x0000011ba0126eadi64, 0x0000011e8084a371i64,
    0x0000012160f11bc6i64, 0x000001244157d7c3i64, 0x0000012721b8d77fi64, 0x0000012a02141b10i64,
    0x0000012ce269a28ei64, 0x0000012fc2b96e0fi64, 0x00000132a3037daai64, 0x000001358347d177i64,
    0x000001386386698ci64, 0x0000013b43bf45ffi64, 0x0000013e23f266e9i64, 0x00000141041fcc5ei64,
    0x00000143e4477678i64, 0x00000146c469654bi64, 0x00000149a48598f0i64, 0x0000014c849c117ci64,
    0x0000014f64accf08i64, 0x0000015244b7d1a9i64, 0x0000015524bd1976i64, 0x0000015804bca687i64,
    0x0000015ae4b678f2i64, 0x0000015dc4aa90cei64, 0x00000160a498ee31i64, 0x0000016384819134i64,
    0x00000166646479eci64, 0x000001694441a870i64, 0x0000016c24191cd7i64, 0x0000016df6ca19bdi64,
    0x00000171e3b6d7aai64, 0x00000174c37d1e44i64, 0x00000177a33dab1ci64, 0x0000017a82f87e49i64,
    0x0000017d62ad97e2i64, 0x00000180425cf7fei64, 0x00000182b07f3458i64, 0x0000018601aa8c19i64,
    0x00000188e148c046i64, 0x0000018bc0e13b52i64, 0x0000018ea073fd52i64, 0x000001918001065di64,
    0x000001945f88568bi64, 0x000001973f09edf2i64, 0x0000019a1e85ccaai64, 0x0000019cfdfbf2c8i64,
    0x0000019fdd6c6063i64, 0x000001a2bcd71593i64, 0x000001a59c3c126ei64, 0x000001a87b9b570bi64,
    0x000001ab5af4e380i64, 0x000001ae3a48b7e5i64, 0x000001b11996d450i64, 0x000001b3f8df38d9i64,
    0x000001b6d821e595i64, 0x000001b9b75eda9bi64, 0x000001bc96961803i64, 0x000001bf75c79de3i64,
    0x000001c254f36c51i64, 0x000001c534198365i64, 0x000001c81339e336i64, 0x000001caf2548bd9i64,
    0x000001cdd1697d67i64, 0x000001d0b078b7f5i64, 0x000001d38f823b9ai64, 0x000001d66e86086di64,
    0x000001d94d841e86i64, 0x000001dc2c7c7df9i64, 0x000001df0b6f26dfi64, 0x000001e1ea5c194ei64,
    0x000001e4c943555di64, 0x000001e7a824db23i64, 0x000001ea8700aab5i64, 0x000001ed65d6c42bi64,
    0x000001f044a7279di64, 0x000001f32371d51fi64, 0x000001f60236cccai64, 0x000001f8e0f60eb3i64,
    0x000001fbbfaf9af3i64, 0x000001fe9e63719ei64, 0x000002017d1192cci64, 0x000002045bb9fe94i64,
    0x000002073a5cb50di64, 0x00000209c06e6212i64, 0x0000020cf791026ai64, 0x0000020fd622997ci64,
    0x00000212b07f3458i64, 0x000002159334a8d8i64, 0x0000021871b52150i64, 0x0000021b502fe517i64,
    0x0000021d6a73a78fi64, 0x000002210d144eeei64, 0x00000223eb7df52ci64, 0x00000226c9e1e713i64,
    0x00000229a84024bbi64, 0x0000022c23679b4ei64, 0x0000022f64eb83a8i64, 0x000002324338a51bi64,
    0x00000235218012a9i64, 0x00000237ffc1cc69i64, 0x0000023a2c3b0ea4i64, 0x0000023d13ee805bi64,
    0x0000024035e9221fi64, 0x00000243788faf25i64, 0x0000024656b4e735i64, 0x00000247ed646bfei64,
    0x0000024c12ee3d98i64, 0x0000024ef1025c1ai64, 0x00000251cf10c799i64, 0x0000025492644d65i64,
    0x000002578b1c85eei64, 0x0000025a6919d8f0i64, 0x0000025d13ee805bi64, 0x0000026025036716i64,
    0x0000026296453882i64, 0x00000265e0d62b53i64, 0x00000268beb701f3i64, 0x0000026b9c92265ei64,
    0x0000026d32f798a9i64, 0x00000271583758ebi64, 0x000002743601673bi64, 0x0000027713c5c3b0i64,
    0x00000279f1846e5fi64, 0x0000027ccf3d6761i64, 0x0000027e6580aecbi64, 0x000002828a9e44b3i64,
    0x0000028568462932i64, 0x00000287bdbf5255i64, 0x0000028b2384de4ai64, 0x0000028d13ee805bi64,
    0x0000029035e9221fi64, 0x0000029296453882i64, 0x0000029699bdfb61i64, 0x0000029902a37aabi64,
    0x0000029c54b864c9i64, 0x0000029deabd1083i64, 0x000002a20f9c0bb5i64, 0x000002a4c7605d61i64,
    0x000002a7bdbf5255i64, 0x000002a96056dafci64, 0x000002ac3daf14efi64, 0x000002af1b019ecai64,
    0x000002b296453882i64, 0x000002b5d022d80fi64, 0x000002b8fa471cb3i64, 0x000002ba9012e713i64,
    0x000002bd6d4901cci64, 0x000002c04a796cf6i64, 0x000002c327a428a6i64, 0x000002c61a5e8f4ci64,
    0x000002c8e1e891f6i64, 0x000002cbbf023fc2i64, 0x000002ce9c163e6ei64, 0x000002d179248e13i64,
    0x000002d4562d2ec6i64, 0x000002d73330209di64, 0x000002da102d63b0i64, 0x000002dced24f814i64,
];

/// Compute 2^44*log2(input+1) - exact implementation from C crush_ln function
pub fn crush_ln(xin: u32) -> u64 {
    let mut x = xin + 1;
    let mut iexpon = 15;

    // Normalize input
    if (x & 0x18000) == 0 {
        let bits = (x & 0x1FFFF).leading_zeros() as i32 - 16;
        x <<= bits;
        iexpon = 15 - bits;
    }

    let index1 = ((x >> 8) << 1) as usize;
    // RH ~ 2^56/index1
    let rh = RH_LH_TBL[index1 - 256];
    // LH ~ 2^48 * log2(index1/256)
    let lh = RH_LH_TBL[index1 + 1 - 256];

    // RH*x ~ 2^48 * (2^15 + xf), xf<2^8
    let xl64 = ((x as i64) * rh) >> 48;

    let mut result = (iexpon as u64) << (12 + 32);

    let index2 = (xl64 & 0xff) as usize;
    // LL ~ 2^48*log2(1.0+index2/2^15)
    let ll = LL_TBL[index2];

    let lh_final = (lh + ll) >> (48 - 12 - 32);
    result += lh_final as u64;

    result
}