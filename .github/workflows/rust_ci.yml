name: Rust CI

on:
  push:
    branches: [main] # Adjust if your main branch is different, e.g., master
  pull_request:
    branches: [main] # Adjust if your main branch is different

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: stable # Or a specific version

jobs:
  build_and_test:
    name: Build and Test (Ubuntu)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: "recursive" # If your project uses git submodules (e.g., googletest)

      - name: Install system dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libclang-dev \
            libssl-dev # For Rust networking, if any crate needs it

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          profile: minimal
          override: true

      - name: Cache Cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            crush-sys/target/
            mycrush/target/ # Cache the target dir of the mycrush crate
          key: ${{ runner.os }}-cargo-${{ hashFiles('crush-sys/Cargo.lock') }}-${{ hashFiles('mycrush/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build
        run: cargo build --verbose --workspace

      - name: Test
        run: cargo test --verbose --workspace
